------

# **產品需求文件 (PRD)：YTPL_Downloader v1.2**

## **版本歷史**

- v1.0 (2024-01-10): 初始版本
- v1.1 (2024-01-13): 新增斷點續傳需求、檔案命名規範、效能監控需求
- v1.2 (2025-06-15): 修正影片解析度下載邏輯，新增純文字摘要報告與永久日誌檔案功能。

## **1. 專案願景與目標**

- **專案名稱**：YTPL_Downloader
- **核心目標**：作為一個**獨立且自動化**的「YouTube 內容入庫」工具。其主要職責是高效、穩定地監控使用者指定的 YouTube Playlist，自動下載其中未處理的新影片內容，並將所有相關資料**「自給自足」地儲存**到本地檔案系統中，同時在成功處理後自動從雲端 Playlist 移除。
- **主要價值主張**：為後續的影片處理流程（例如翻譯和合成）提供**標準化、完整且易於獲取**的原始影片資料，並簡化使用者將影片加入處理佇列的流程（只需將影片加入 YouTube Playlist）。
- **終極願景**：成為 YTPL 系統中**可靠且獨立的內容獲取引擎**，將 YouTube 影片內容無縫橋接到本地檔案系統。

## **2. 功能需求 (Functional Requirements)**

### **2.1 Playlist 監控機制**

- 能夠**定期掃描**使用者在**設定檔 (config.ini)** 中指定的一個或多個 YouTube **Playlist URL**。
- 將每個 Playlist 視為一個獨立的、一次性處理的「**下載佇列**」。

### **2.2 新影片識別與處理**

- 透過**掃描對應 Playlist 的本地下載目錄**中已存在的影片 ID（從每個影片子資料夾內的 video_info.json 中獲取），來判斷 Playlist 中的影片是否為尚未處理的新影片。
- 一旦識別出新影片，立即觸發其下載流程。

### **2.3 完整內容下載**

- **最高解析度影片 (v1.2 修訂)**：確保下載的是**最高品質的視訊流 (best video)** 與**最高品質的音訊流 (best audio)**，並自動合併。
- **所有可用音軌**：下載影片中所有可用的音軌（包括原始英文音軌和所有其他語言音軌）。
- **所有可用字幕**：下載影片中所有可用的字幕檔案（包括原始英文字幕，以及所有其他語言字幕）。
- **豐富元數據**：以標準 **JSON 檔案格式**（檔名固定為 video_info.json）儲存影片的所有核心元數據。
- **縮圖/截圖**：下載影片的縮圖或主要截圖。
- **斷點續傳支援** (v1.1 新增)：支援大檔案的斷點續傳，確保下載的可靠性。

### **2.4 本地「自給自足」儲存結構**

- 每個 Playlist 都有其**獨立的絕對根儲存目錄**，由 config.ini 指定。
- 在該 Playlist 對應的根目錄下，為每個下載的影片**創建一個獨立的子資料夾**。
- **標準化命名規則** (v1.1 新增)：子資料夾命名格式為 `[YYYY-MM-DD]_[sanitized_title]_[video_id]`，確保唯一性和可讀性。
- 將該影片的**所有下載內容**直接存儲在這個獨立的子資料夾中。
- **本地可播放性**：確保這些檔案可以直接透過本地播放軟體播放或查看。
- **版本化資料結構** (v1.1 新增)：video_info.json 包含 schema_version 欄位，支援未來升級。
- **效能追蹤** (v1.1 新增)：記錄下載效能指標（速度、耗時、檔案大小等）。

### **2.5 下載後從雲端 Playlist 移除**

- **關鍵自動化步驟**：在一個影片的所有指定內容**成功下載並驗證儲存**到對應的本地目錄後，YTPL_Downloader 必須自動將該影片從其所屬的 YouTube Playlist 中移除。

### **2.6 執行摘要與日誌記錄 (v1.2 新增)**

- 螢幕總結報告

  ：在每次程式執行結束時，於標準輸出 (stdout) 顯示一份

  純文字

  的執行摘要。報告應包含：

  - 處理的 Playlist 總數。
  - 成功下載的新影片數量。
  - 下載失敗的影片數量。
  - 因已存在而跳過的影片數量。
  - 總耗時。

- **永久日誌檔案**：除了螢幕輸出外，程式必須將本次執行的所有詳細日誌寫入一個位於 `logs/` 目錄下的獨立日誌檔案中。

## **3. 非功能需求 (Non-Functional Requirements)**

- **高頻響應**：從用戶將影片加入監控 Playlist 到 YTPL_Downloader 開始處理影片的延遲應**少於 5 分鐘**。

- **效率**：下載影片的效率應盡可能高，充分利用可用網路頻寬。

- 可靠性與錯誤處理

  ：

  - **自動重試機制**：對於因網路瞬斷、API 臨時性超時等可恢復性錯誤，應具備內建的重試邏輯。
  - **清晰的錯誤報告**：當發生無法自動恢復的錯誤時，應在日誌或標準錯誤中提供清晰的錯誤訊息。
  - **冪等性**：即使在下載或移除影片過程中有中斷或失敗，重新運行時也應避免重複下載。
  - **斷點續傳** (v1.1 新增)：支援從中斷點繼續下載，減少重複傳輸。

- **資源使用**：在空閒狀態下，CPU 和記憶體佔用應非常低。

- **配置簡單性**：所有配置應集中在一個易於理解和修改的 config.ini 檔案中。

- **可觀察性**：應輸出清晰的日誌訊息，包含監控活動、下載進度、完成狀態、錯誤和警告。

- **無資料庫依賴**：完全依賴檔案系統和 video_info.json 檔案來管理已處理的影片狀態。

## **4. 輸入 (Input)**

- 設定檔 (config.ini)

  ：此專案的唯一配置輸入來源。

  - 結構為多個區塊 (sections)，每個區塊代表一個要監控的 YouTube Playlist。

  - 每個 Playlist 區塊的內容

    ：

    - playlist_url: 該 Playlist 的完整 YouTube URL。
    - download_directory: 該 Playlist 下載內容的**絕對根儲存目錄路徑**。

  - 通用配置區塊

     (例如 [General])：

    - youtube_api_credentials: 包含 YouTube Data API 操作所需的認證資訊。
    - check_interval_seconds: 內部邏輯循環等待時間。

- **排程觸發**：該專案將透過**外部定時器**（例如 macOS 的 launchd）定時觸發執行。

## **5. 輸出 (Output)**

- 本地檔案系統

  ：

  - 在每個 Playlist 對應的 download_directory/ 下，生成多個獨立的**影片子資料夾**。
  - **標準化資料夾命名** (v1.1 新增)：格式為 `[YYYY-MM-DD]_[sanitized_title]_[video_id]`。
  - 每個資料夾內包含完整的影片相關檔案。
  - **(v1.2 新增)** 在專案根目錄下建立 `logs/` 子目錄，用於存放日誌檔案。

- 標準輸出 (stdout) / 日誌

  ：

  - 進度與狀態更新。
  - **關鍵輸出**：每成功處理一個影片後，清晰地印出該影片在本地檔案系統中**其獨立子資料夾的絕對路徑**。
  - **執行摘要報告 (v1.2 新增)**：在程式結束時，於螢幕上顯示一份純文字的執行摘要。

- **標準錯誤 (stderr) / 日誌**：任何錯誤、警告或異常情況的詳細訊息。

- 日誌檔案 (v1.2 新增)

  ：

  - 在 `logs/` 目錄中，生成以**執行時間命名**的日誌檔案（例如：`ytpl_downloader_2025-06-15_15-21-38.log`）。
  - 該檔案包含本次執行的所有詳細日誌訊息。