

------

## **YTPL_Downloader v1.2 升級說明文件**

**目標**：指導 AI Coding 工具將 `YTPL_Downloader` 專案從 v1.1 升級至 v1.2。

**核心升級點**：

1. 修正影片下載邏輯，確保下載最高可用解析度。
2. 增強日誌功能，實現檔案與控制台雙通道輸出。
3. 在程式結束時，新增一個純文字的執行摘要報告。

------

### **1. PRD (產品需求文件) v1.2 升級內容**

以下是 v1.2 相對於 v1.1 的主要需求變更：

- **修正影片下載需求 (第 2.3 節)**
  - `最高解析度影片` 的定義被明確化。現在要求**必須**下載「最高品質的視訊流 (best video) 與最高品質的音訊流 (best audio)」，並自動合併。
- **新增執行摘要與日誌記錄需求 (第 2.6 節)**
  - 這是一個全新的功能需求章節。
  - 要求在程式結束時，於螢幕 (stdout) 顯示一份**純文字**的執行摘要報告。
  - 報告需包含：處理的 Playlist 總數、成功/失敗/跳過的影片數量、總耗時。
  - 要求程式必須將所有詳細日誌，寫入一個位於 `logs/` 目錄下的永久日誌檔案中。
- **更新輸出規格 (第 5 節)**
  - 在`本地檔案系統`輸出中，新增了在專案根目錄下建立 `logs/` 子目錄的要求。
  - 在`標準輸出 (stdout)`中，新增了「執行摘要報告」作為輸出項。
  - 新增了`日誌檔案`作為一個全新的輸出類型，並規定了檔名格式（以執行時間命名）和存放位置 (`logs/` 目錄)。

------

### **2. SDD (系統設計文件) v1.2 升級內容**

以下是實現 v1.2 需求的具體技術設計變更：

- **專案目錄結構 (第 1.1 節)**

  - 在專案根目錄下新增 `logs/` 資料夾，用以存放日誌檔案。

- **主要程式模組與職責 (第 1.2 節)**

  - **`main_downloader.py`**：職責擴充，除了協調流程外，還需要在執行過程中**收集統計數據**，並在結束時呼叫一個**內部輔助函數**來打印摘要報告。
  - **`logger.py`**：職責更新，必須設定**雙通道日誌**，同時將日誌輸出到**控制台 (console)** 和**帶時間戳的日誌檔案**。

- **核心流程設計 (第 3 節)**

  - **啟動與初始化 (第 3.1 節)**：`日誌系統初始化`步驟現在必須創建一個位於 `logs/` 目錄下的檔案，並設定好雙通道輸出。

  - 影片處理流程 (第 3.4 節)

    ：這是

    最重要的修正

    。在呼叫 

    ```
    yt-dlp
    ```

     時，

    必須

    新增以下兩個命令行參數：

    1. `--format "bestvideo*+bestaudio/best"`
    2. `--merge-output-format mp4`

  - 執行總結與報告 (第 3.6 節)

    ：此為

    全新

    的流程章節。

    - **數據收集**：需要在 `main_downloader.py` 中建立一個簡單的字典 (`stats`) 來累加成功、失敗、跳過的影片數量，並記錄開始時間。
    - **報告生成**：需要在 `main_downloader.py` 的 `finally` 區塊中，呼叫一個內部輔助函數 (`_print_summary_report`)，該函數負責計算總耗時並格式化打印出純文字報告。

------

### **3. 升級改版注意事項 (給 AI 工具的嚴格指令)**

- **禁止改動範圍**：本次升級**嚴禁**對以下模組的現有邏輯進行任何非必要的修改或重構：`config_parser.py`、`youtube_api_client.py`、`file_manager.py`。你的任務是**擴充**功能，不是最佳化現有程式碼。

- **禁止新增檔案**：**不准**為了本次升級而建立任何新的 `.py` 檔案。所有報告生成邏輯必須整合到 `main_downloader.py` 內部。

- 嚴格遵循設計

  ：所有程式碼修改必須嚴格依據 SDD v1.2 文件執行。

  - `logger.py` 的修改必須實現雙通道日誌。
  - `video_downloader.py` (或其呼叫者) 在執行 `yt-dlp` 時必須加上指定的 `--format` 和 `--merge-output-format` 參數。
  - `main_downloader.py` 必須在內部實作數據收集和報告打印。

- **確認機制**：在對 `main_downloader.py` 進行修改之前，必須先用文字描述你計畫如何以及在何處插入統計變數和最終的報告打印函數。得到我的確認後才能產生程式碼。

------

### **4. 額外建議 (給 AI 工具的加分項)**

- **優先級**：請將「修正 `yt-dlp` 下載參數」視為本次升級的最高優先級任務，務必確保它被正確實作。
- **程式碼註解**：在你新增的程式碼區塊（例如 `main_downloader.py` 中的數據收集和報告函數），請加上簡潔的註解，說明其用途。例如：`# Collect execution statistics` 和 `# Print summary report at the end`。
- **日誌訊息**：在 `main_downloader.py` 打印摘要報告時，請確保報告中包含了最終日誌檔案的完整路徑，如 SDD v1.2 範例所示，這對使用者非常重要。
- **冪等性考量**：請確保你在 `main_downloader.py` 中用於統計的變數（例如 `stats` 字典）是在每次程式執行時重新初始化的，而不是一個持續存在的狀態，以保證每次運行的報告都是獨立的。